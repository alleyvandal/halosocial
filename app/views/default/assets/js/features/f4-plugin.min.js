jQuery.extend(!0,halo,{user:{banForm:function(userId){return"undefined"!=typeof userId&&userId?void halo.jax.call("ban","ShowForm",userId):!1},submitBan:function(userId){if("undefined"==typeof userId||!userId)return!1;var values=halo.util.getFormValues("popupForm");halo.jax.call("ban","SubmitForm",userId,values)},toggleBan:function(ele){$row=jQuery(ele).closest(".halo-ban-setting"),$duration=$row.find(".halo-ban-duration"),$duration.length&&$duration.toggleClass("hidden")}}}),!function($){"use strict";function updateCss($this){var $parent=getParent($this),height=0,right=0;if($parent.hasClass("halo-conv-active")){var contentHeight=($this.outerHeight(),$parent.children(".halo-dropdown-menu").first().outerHeight());$parent.hasClass("open")&&(height=contentHeight),$parent.prevAll(".halo-conv-active").each(function(){right=right+jQuery(this).outerWidth()+4})}else height=-999,right=0;$parent.css("bottom",height).css("position","absolute").css("right",right).css("zIndex",1999),updateCollapseConv()}function updateCollapseConv(){jQuery("#halo-collapsed-conv-wrapper").remove();var convs=jQuery("[data-convid]"),collapseList="";if(convs.each(function(){var $this=jQuery(this);if(!$this.hasClass("halo-conv-active")){var title=$this.find('[data-htoggle="conv"]').html(),convId=$this.attr("data-convid");collapseList+='<li><a href="javascript:void(0)" onclick="halo.message.openConvByConvId(\''+convId+"')\">"+title+"</a></li>"}}),collapseList.length){var collapse=jQuery('<div class="dropup" id="halo-collapsed-conv-wrapper"><button id="halo-collapsed-conv-btn" type="button" class="halo-btn halo-btn-default halo-dropdown-toggle" data-htoggle="dropdown"><i class="fa fa-th-list"></i></button><ul class="halo-dropdown-menu" role="menu" aria-labelledby="dLabel">'+collapseList+"</ul></div>");jQuery('[data-halozone="message-zone"]').append(collapse),collapse.css("bottom",10),collapse.css("right",getActiveConvWidth()+10).css("position","fixed").css("zIndex",999),jQuery("#halo-collapsed-conv-btn").hdropdown(),jQuery(".halo-conv-unread-counter",collapse).length?halo.util.startFlash(jQuery("#halo-collapsed-conv-btn"),-1):halo.util.stopFlash(jQuery("#halo-collapsed-conv-btn"))}}function getParent($this){var $parent,selector=$this.attr("data-target");return selector||(selector=$this.attr("href"),selector=selector&&/#/.test(selector)&&selector.replace(/.*(?=#[^\s]*$)/,"")),$parent=selector&&jQuery(selector),$parent&&$parent.length||($parent=$this.parent()),$parent}function getActiveConvWidth(){var activeWidth=0;return jQuery(".halo-conv-active").each(function(){activeWidth+=jQuery(this).outerWidth()+4}),activeWidth}function canStackNewConv(){var activeWidth=getActiveConvWidth(),collapseWidth=200,convWidth=250;return jQuery(window).width()-activeWidth-collapseWidth-convWidth>0}var toggle="[data-htoggle=conv]",Conv=function(element){jQuery(element).on("click.conv.data-api",this.toggle)};Conv.prototype={constructor:Conv,toggle:function(e){var $parent,isActive,$this=jQuery(this);if(!$this.is(".disabled, :disabled"))return $parent=getParent($this),isActive=$parent.hasClass("open"),$parent.toggleClass("open"),updateCss($this),isActive?halo.storage.setAttr("conv","convid_"+$parent.attr("data-convid"),"status","close"):halo.storage.setAttr("conv","convid_"+$parent.attr("data-convid"),"status","open"),!1},init:function(e){var $this=jQuery(this);return updateCss($this),!1},open:function(e){var $parent,isActive,$this=jQuery(this);if(!$this.is(".disabled, :disabled"))return $parent=getParent($this),isActive=$parent.hasClass("open"),isActive||$parent.addClass("open"),$parent.hasClass("halo-conv-active")||canStackNewConv()||jQuery(".halo-conv-active").last().find('[data-htoggle="conv"]').first().conv("collapse"),$parent.addClass("halo-conv-active"),updateCss($this),halo.storage.setAttr("conv","convid_"+$parent.attr("data-convid"),"status","open"),!1},close:function(e){var $parent,$this=jQuery(this);if(!$this.is(".disabled, :disabled"))return $parent=getParent($this),$parent.removeClass("open"),$parent.addClass("halo-conv-active"),updateCss($this),halo.storage.setAttr("conv","convid_"+$parent.attr("data-convid"),"status","close"),!1},remove:function(e){var $parent,$this=jQuery(this);$parent=getParent($this),halo.storage.deleteObj("conv","convid_"+$parent.attr("data-convid"));var isActive=$parent.hasClass("halo-conv-active");if($parent.remove(),isActive){var replacement=jQuery("[data-convid]:not(.halo-conv-active)").first();replacement.length&&jQuery('[data-htoggle="conv"]',replacement).conv("open")}return jQuery('.halo-conv-active [data-htoggle="conv"]').each(function(){updateCss(jQuery(this))}),!1},collapse:function(e){var $parent,$this=jQuery(this);return $parent=getParent($this),$parent.removeClass("halo-conv-active"),updateCss($this),halo.storage.setAttr("conv","convid_"+$parent.attr("data-convid"),"status","collapse"),!1}};var old=jQuery.fn.conv;jQuery.fn.conv=function(option){return this.each(function(){var $this=jQuery(this),data=$this.data("conv");data||$this.data("conv",data=new Conv(this)),"string"==typeof option&&data[option].call($this)})},jQuery.fn.conv.Constructor=Conv,jQuery.fn.conv.noConflict=function(){return jQuery.fn.conv=old,this},jQuery(document).on("click.conv.data-api",".conv form",function(e){e.stopPropagation()}).on("click.conv-menu",function(e){e.stopPropagation()}).on("click.conv.data-api",toggle,Conv.prototype.toggle)}(window.jQuery),jQuery.extend(!0,halo,{message:{minWindowSize:768,loaded:!1,fullviewId:0,loadConvs:function(convIds){halo.jax.call("message","LoadConvs",convIds)},openConvByPost:function(userId,targetUrl){"undefined"!=typeof targetUrl&&!halo.storage.setDn("curpost",{url:targetUrl}),halo.message.openConvByUserId(userId)},autoFillConv:function(params){var post=halo.storage.getDn("curpost");return post?(params.$input.val(post.url+"\n"),params.$input.caretToEnd(),void halo.storage.deleteDn("curpost")):!1},openConvByUserId:function(userId){halo.message.hasConvWindow()||halo.jax.call("message","OpenConvByUserId",userId,1);var $conv=jQuery('[data-convuserid="'+userId+'"]');if($conv.length){var convId=$conv.attr("data-convid");halo.message.focusConv(convId)}else halo.jax.call("message","OpenConvByUserId",userId,0)},openConvByConvId:function(convId){if(halo.message.hasConvWindow()&&convId!=halo.message.fullviewId){var $conv=jQuery('[data-convid="'+convId+'"]');$conv.length?halo.message.focusConv(convId):halo.jax.call("message","OpenConvByConvId",convId)}},changeConv:function(convId){halo.jax.call("message","ChangeConv",convId)},focusConvFullView:function(convId){setTimeout(function(){jQuery("#message-input-"+convId+" textarea").focus()},100)},focusConv:function(convId){halo.message.removeConvStorage(convId);var $conv=jQuery('[data-convid="'+convId+'"]');halo.message.displayConv(convId),halo.util.startFlash($conv.find(".halo-conv-window-title"),3),$conv.find("textarea").focus()},updateLastSeenMessage:function(convId,lastseen_id){halo.jax.call("message","UpdateLastSeenMessage",convId,lastseen_id)},showOlderConvs:function(){halo.jax.call("message","ShowOlderConvs")},setConvAsOldest:function(convId){var $oldestMessage=jQuery('[data-convid="'+convId+'"] [data-msgid]').first();$oldestMessage.length&&$oldestMessage.addClass("halo-conv-message-oldest")},addConv:function(content){var $content=jQuery(content),zoneId=$content.data("halozone"),convId=$content.data("convid");if(convId!=halo.message.fullviewId){var $conv=jQuery('[data-halozone="'+zoneId+'"]');if($conv.length){var $currContentWrapper=jQuery(".halo-conv-entry-wrapper",$conv),$newContentWrapper=jQuery(".halo-conv-entry-wrapper",$content),$mergeContent=halo.util.mergeContent(jQuery("[data-msgid]",$currContentWrapper),jQuery("[data-msgid]",$newContentWrapper),"data-msgid");$currContentWrapper.children().remove(),$currContentWrapper.append(jQuery($mergeContent))}else{var $messageWrapper=jQuery('[data-halozone="message-zone"]'),$messageList=jQuery('[data-halozone="message-zone-list"]',$messageWrapper);!$messageList.length,$messageList.append($content)}halo.init($content),halo.message.displayConv(convId)}},showFullViewMessages:function(messages){var $fullview=jQuery(".halo-conv-fullview-wrapper"),$contentWrapper=jQuery(".halo-conv-entry-wrapper",$fullview);if($contentWrapper.length){var $oldestMessage=jQuery("[data-msgid]",$contentWrapper).first();$oldestMessage.before(jQuery(messages))}},stopFullViewLoadMore:function(){{var $fullview=jQuery(".halo-conv-fullview-wrapper");jQuery(".halo-conv-entry-wrapper",$fullview)}jQuery(".halo-conv-load-more",$fullview).addClass("hide"),jQuery(".halo-conv-entry-wrapper",$fullview).off("scroll")},stickFullViewScroll:function(){var $fullview=jQuery(".halo-conv-fullview-wrapper"),$contentWrapper=jQuery(".halo-conv-entry-wrapper",$fullview);$contentWrapper[0].scrollTop=$contentWrapper[0].scrollHeight},submit:function(el){var values=halo.util.getFormValues(jQuery(el).attr("id"));halo.util.resetFormValues(jQuery(el).attr("id")),halo.jax.call("message","Submit",values)},init:function(scope){if("undefined"!=typeof halo_my_id&&0!=halo_my_id&&"undefined"!=typeof halo_feature_message&&0!=halo_feature_message&&(halo.message.initFullViewMode(scope),halo.message.hasConvWindow()))if(halo.message.loaded)jQuery(scope).on("keydown",".halo-message-input",function(e){var code=e.keyCode||e.which;return 13!=code||e.shiftKey?void 0:(e.preventDefault(),halo.message.submit(jQuery(this).closest("form")),!1)}),jQuery('[data-htoggle="conv"]').conv("init");else{halo.message.loaded=!0;var convs=halo.storage.getDn("conv"),convIds=[];null!=convs&&jQuery.each(convs,function(key,value){var parts=key.split("_");2==parts.length&&"convid"==parts[0]&&parseInt(parts[1])>0&&convIds.push(parts[1])}),setTimeout(function(){halo.jax.call("message","GetContainerHtml",convIds)},1e4)}},initFullViewMode:function(scope){function resizeConvHeight(){var $convEntries=jQuery(".halo-conv-entry-wrapper",$fullview),pos=halo.util.getPosition($convEntries),delta=jQuery(window).height()-(pos.top+pos.height+$convEntries.next().height()+40);$convEntries.css("height",pos.height+delta),jQuery(".halo-inbox-conv-list").height(jQuery(".halo-inbox-conv-view").height())}var $fullview=jQuery(".halo-conv-fullview-wrapper",scope);$fullview.length&&($fullview.on("keydown",".halo-message-input",function(e){var code=e.keyCode||e.which;return 13!=code||e.shiftKey?void 0:(e.preventDefault(),halo.message.submit(jQuery(this).closest("form")),!1)}),halo.message.fullviewId=$fullview.attr("data-fullview-convid"),halo.message.stickFullViewScroll(),jQuery(".halo-conv-entry-wrapper",$fullview).off("scroll").on("scroll",halo.util.throttle(function(){var $contentWrapper=jQuery(this),scrollTop=$contentWrapper.scrollTop();if(0==scrollTop){var $oldestMessage=jQuery("[data-msgid]",$contentWrapper).first();if($oldestMessage.length)if($oldestMessage.hasClass("halo-conv-message-oldest"));else{var lastId=$oldestMessage.attr("data-msgid");halo.jax.call("message","LoadOlderFullViewMessages",halo.message.fullviewId,lastId)}}},500)),setTimeout(function(){resizeConvHeight()},100),jQuery(window).on("resize",halo.util.throttle(function(){resizeConvHeight()},500)),$fullview.on("message.autofill",function(evt){halo.message.autoFillConv({$input:jQuery(this).find("textarea.halo-message-input")})}),$fullview.trigger("message.autofill"))},hasConvWindow:function(){return 1==window.halo_popup_message_win&&jQuery(window).width()>halo.message.minWindowSize},hideConvWindow:function(){"undefined"==typeof window.halo_popup_message_win&&(window.halo_popup_message_win=0),window.halo_popup_message_win=0},updater:function(scope){if(halo.message.hasConvWindow()&&jQuery("#halo-message-wrapper").length){values={},values.form={};var latestId=0;return jQuery("#halo-message-wrapper [data-convid], .halo-conv-fullview-wrapper").each(function(){var msg=jQuery("[data-msgid]",jQuery(this)).last();if(msg.length>0){var msgId=parseInt(msg.data("msgid"));latestId=msgId>latestId?msgId:latestId}}),values.form.context="message",values.form.latestId=latestId,values.form.fullviewId=halo.message.fullviewId,values}},updateUnreadCounter:function(convId){var $conv=jQuery('[data-convid="'+convId+'"]'),unreadMessages=jQuery(".halo-message-unread",$conv);if(unreadMessages.length){var counter=jQuery(".halo-conv-unread-counter",$conv);counter.length?counter.html(unreadMessages.length):(jQuery('[data-htoggle="conv"]',$conv).append('<span class="halo-conv-unread-counter badge halo-badge">'+unreadMessages.length+"</span>"),halo.util.startFlash($conv.find(".halo-conv-window-title"),-1),"panel"!=convId&&(jQuery('[data-recent-convid="'+convId+'"] a').append('<span class="halo-message-unread badge halo-badge small">&nbsp;</span>'),halo.message.updateUnreadCounter("panel")))}else jQuery(".halo-conv-unread-counter",$conv).remove(),halo.util.stopFlash($conv.find(".halo-conv-window-title")),"panel"!=convId&&(jQuery('[data-recent-convid="'+convId+'"] .halo-message-unread').remove(),halo.message.updateUnreadCounter("panel"))},displayConv:function(convId){var $conv=jQuery('[data-convid="'+convId+'"]'),status=halo.storage.getAttr("conv","convid_"+convId,"status");null===status&&(status="open"),jQuery('[data-htoggle="conv"]',$conv).conv(status);var unreadMessages=jQuery(".halo-message-unread",$conv).closest("[data-msgid]"),firstUnreadMessage=unreadMessages.first(),viewportHeight=jQuery(".halo-conv-entry-wrapper",$conv).height(),$contentWrapper=jQuery(".halo-conv-entry-wrapper",$conv),lastScrollMessageId=$conv.attr("data-conv-lastscrollid");if($conv.removeAttr("data-conv-lastscrollid"),"undefined"==typeof lastScrollMessageId)if(firstUnreadMessage.length){if(firstUnreadMessage.position().top+firstUnreadMessage.innerHeight()>viewportHeight){var currScrollTop=$contentWrapper.scrollTop(),newScrollTop=currScrollTop+firstUnreadMessage.position().top-(viewportHeight-firstUnreadMessage.innerHeight());$contentWrapper.scrollTop(newScrollTop)}}else $contentWrapper.each(function(){this.scrollTop=this.scrollHeight});else{var lastScrollMessage=jQuery('[data-msgid="'+lastScrollMessageId+'"]',$conv);if(lastScrollMessage.length){var currScrollTop=$contentWrapper.scrollTop(),newScrollTop=currScrollTop+lastScrollMessage.position().top-(viewportHeight-lastScrollMessage.innerHeight());$contentWrapper.scrollTop(newScrollTop)}}halo.message.updateUnreadCounter(convId),jQuery(".halo-conv-entry-wrapper",$conv).off("scroll").on("scroll",halo.util.throttle(function(){var $contentWrapper=jQuery(this),scrollTop=$contentWrapper.scrollTop();if(0==scrollTop){var $oldestMessage=jQuery("[data-msgid]",$contentWrapper).first();if($oldestMessage.length)if($oldestMessage.hasClass("halo-conv-message-oldest"));else{var lastId=$oldestMessage.attr("data-msgid");$conv.attr("data-conv-lastscrollid",lastId),halo.jax.call("message","LoadOlderMessages",convId,lastId)}}else{var seen_id=0;jQuery("[data-msgid]",$contentWrapper).each(function(){var $this=jQuery(this),messageBagde=jQuery(".halo-message-unread",$this);messageBagde.length>0&&$this.position().top+$this.height()<$contentWrapper.innerHeight()&&(messageBagde.hide("slow",halo.util.throttle(function(){messageBagde.remove(),halo.message.updateUnreadCounter(convId)},200)),seen_id=$this.attr("data-msgid"))}),seen_id>0&&halo.message.updateLastSeenMessage(convId,seen_id)}},500));var $textArea=$conv.find("textarea.halo-message-input");$textArea.on("click",function(){var seen_id=0,$contentWrapper=jQuery(".halo-conv-entry-wrapper",$conv);jQuery("[data-msgid]",$contentWrapper).each(function(){var $this=jQuery(this),messageBagde=jQuery(".halo-message-unread",$this);messageBagde.length>0&&$this.position().top+$this.height()<$contentWrapper.innerHeight()&&(messageBagde.hide("slow",halo.util.throttle(function(){messageBagde.remove(),halo.message.updateUnreadCounter(convId)},200)),seen_id=$this.attr("data-msgid"))}),seen_id>0&&halo.message.updateLastSeenMessage(convId,seen_id)}),$conv.on("message.autofill",function(evt){halo.message.autoFillConv({$input:$textArea})}),$conv.trigger("message.autofill")},toggleDisplayConv:function(convId){var $conv=jQuery('[data-convid="'+convId+'"]');jQuery('[data-htoggle="conv"]',$conv).conv("toggle")},removeConv:function(convId){var $conv=jQuery('[data-convid="'+convId+'"]');jQuery('[data-htoggle="conv"]',$conv).conv("remove")},displayContainer:function(html){if(!jQuery("#halo-message-wrapper").length){var container=jQuery(html);jQuery("body").append(container);var status=halo.storage.getAttr("conv","convid_panel","status");null===status&&(status="open"),jQuery('[data-htoggle="conv"]',container).conv(status),halo.message.init(container)}},removeConvStorage:function(convId){halo.storage.deleteObj("conv","convid_"+convId)}}}),jQuery.extend(!0,halo,{poll:{submitAnswer:function(){var data=halo.util.getFormValues("PollAnswersForm");halo.jax.call("poll","SubmitAnswer",data)},getOther:function(pollId,order){halo.jax.call("poll","ShowOtherPoll",pollId,order)}}});