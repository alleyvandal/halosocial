var halo_emoticons=[":-)",":o)",":c)",":^)",":-D",":-(",":-9",";-)",":-P",":-p",":-�",":-b",":-O",":-/",":-X",":-#",":'(","B-)","8-)",";*(",":-*",":-\\","?-)",": )",": ]","= ]","= )","8 )",": }",": D","8 D","X D","x D","= D",": (",": [",": {","= (","; )","; ]","; D",": P",": p","= P","= p",": b",": �",": O","8 O",": /","= /",": S",": #",": X","B )",": |",": \\","= \\",": *",": &gt;",": &lt;",":)",":]","=]","=)","8)",":}",":D",":(",":[",":{","=(",";)",";]",";D",":P",":p","=P","=p",":b",":�",":O",":/","=/",":S",":#",":X","B)",":|",":\\","=\\",":*",":&gt;",":&lt;"];!function($){var mirrored,defaults={className:"autosizejs",append:"",callback:!1,minHeight:0,resizeDelay:10},copy='<textarea tabindex="-1" style="position:absolute; top:-999px; left:0; right:auto; bottom:auto; border:0; padding: 0; -moz-box-sizing:content-box; -webkit-box-sizing:content-box; box-sizing:content-box; word-wrap:break-word; height:0 !important; min-height:0 !important; overflow:hidden; transition:none; -webkit-transition:none; -moz-transition:none;"/>',typographyStyles=["fontFamily","fontSize","fontWeight","fontStyle","letterSpacing","textTransform","wordSpacing","textIndent"],mirror=$(copy).data("autosize",!0)[0];mirror.style.lineHeight="99px","99px"===$(mirror).css("lineHeight")&&typographyStyles.push("lineHeight"),mirror.style.lineHeight="",$.fn.autosize=function(options){return this.length?(options=$.extend({},defaults,options||{}),mirror.parentNode!==document.body&&$(document.body).append(mirror),this.each(function(){function setWidth(){var width,style=window.getComputedStyle?window.getComputedStyle(ta,null):!1;style?(width=ta.getBoundingClientRect().width,$.each(["paddingLeft","paddingRight","borderLeftWidth","borderRightWidth"],function(i,val){width-=parseInt(style[val],10)}),mirror.style.width=width+"px"):mirror.style.width=Math.max($ta.width(),0)+"px"}function initMirror(){var styles={};if(mirrored=ta,mirror.className=options.className,maxHeight=parseInt($ta.css("maxHeight"),10),$.each(typographyStyles,function(i,val){styles[val]=$ta.css(val)}),$(mirror).css(styles),setWidth(),window.chrome){var width=ta.style.width;ta.style.width="0px";{ta.offsetWidth}ta.style.width=width}}function adjust(){var height,original;mirrored!==ta?initMirror():setWidth(),mirror.value=ta.value+options.append,mirror.style.overflowY=ta.style.overflowY,original=parseInt(ta.style.height,10),mirror.scrollTop=0,mirror.scrollTop=9e4,height=mirror.scrollTop,maxHeight&&height>maxHeight?(ta.style.overflowY="scroll",height=maxHeight):(ta.style.overflowY="hidden",minHeight>height&&(height=minHeight)),height+=boxOffset,original!==height&&(ta.style.height=height+"px",callback&&options.callback.call(ta,ta))}function resize(){clearTimeout(timeout),timeout=setTimeout(function(){var newWidth=$ta.width();newWidth!==width&&(width=newWidth,adjust())},parseInt(options.resizeDelay,10))}var maxHeight,minHeight,timeout,ta=this,$ta=$(ta),boxOffset=0,callback=$.isFunction(options.callback),originalStyles={height:ta.style.height,overflow:ta.style.overflow,overflowY:ta.style.overflowY,wordWrap:ta.style.wordWrap,resize:ta.style.resize},width=$ta.width();$ta.data("autosize")||($ta.data("autosize",!0),("border-box"===$ta.css("box-sizing")||"border-box"===$ta.css("-moz-box-sizing")||"border-box"===$ta.css("-webkit-box-sizing"))&&(boxOffset=$ta.outerHeight()-$ta.height()),minHeight=0==options.minHeight?Math.max(parseInt($ta.css("minHeight"),10)-boxOffset||0,$ta.height()):options.minHeight,$ta.css({overflow:"hidden",overflowY:"hidden",wordWrap:"break-word",resize:"none"===$ta.css("resize")||"vertical"===$ta.css("resize")?"none":"horizontal"}),"onpropertychange"in ta?"oninput"in ta?$ta.on("input.autosize keyup.autosize",adjust):$ta.on("propertychange.autosize",function(){"value"===event.propertyName&&adjust()}):$ta.on("input.autosize",adjust),options.resizeDelay!==!1&&$(window).on("resize.autosize",resize),$ta.on("autosize.resize",adjust),$ta.on("autosize.resizeIncludeStyle",function(){mirrored=null,adjust()}),$ta.on("autosize.destroy",function(){mirrored=null,clearTimeout(timeout),$(window).off("resize",resize),$ta.off("autosize").off(".autosize").css(originalStyles).removeData("autosize")}),$ta.on("halo.onreset",adjust),adjust())})):this}}(window.jQuery),function($){"use strict";var bind=function(func,context){return func.bind?func.bind(context):function(){func.apply(context,arguments)}},getStyles=function(){var color;return color=$("<div></div>").css(["color"]).color,"undefined"!=typeof color?function($el,properties){return $el.css(properties)}:function($el,properties){var styles;return styles={},$.each(properties,function(i,property){styles[property]=$el.css(property)}),styles}}(),entityMap={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","/":"&#x2F;"},entityRegexe=/[&<>"'\/]/g,escape=function(str){return str.replace(entityRegexe,function(match){return entityMap[match]})},Overlay=function(){function Overlay($textarea,strategies){var $wrapper,position;position=$textarea.css("position"),"static"===position&&(position="relative"),$wrapper=$(html.wrapper).css($.extend({},css.wrapper,getStyles($textarea,textareaToWrapper),{position:position})),this.textareaTop=parseInt($textarea.css("border-top-width")),this.$el=$(html.overlay).css($.extend({},css.overlay,getStyles($textarea,textareaToOverlay),{top:this.textareaTop,right:parseInt($textarea.css("border-right-width")),bottom:parseInt($textarea.css("border-bottom-width")),left:parseInt($textarea.css("border-left-width"))})),this.$textarea=$textarea.css(css.textarea),this.$textarea.wrap($wrapper).before(this.$el),this.$textarea.origVal=$textarea.val,this.$textarea.val=bind(this.val,this),this.$textarea.on("scroll",bind(this.resizeOverlay,this)),this.$textarea.on("resize",bind(this.resizeOverlay,this)),this.strategies=$.isArray(strategies)?strategies:[strategies],this.renderTextOnOverlay()}var html,css,textareaToWrapper,textareaToOverlay;return html={wrapper:'<div class="textoverlay-wrapper"></div>',overlay:'<div class="textoverlay"></div>'},css={wrapper:{margin:0,padding:0,overflow:"hidden"},overlay:{position:"absolute",color:"transparent","white-space":"pre-wrap","word-wrap":"break-word",overflow:"hidden"},textarea:{background:"transparent",position:"relative",outline:0}},textareaToWrapper=["display"],textareaToOverlay=["margin-top","margin-right","margin-bottom","margin-left","padding-top","padding-right","padding-bottom","padding-left","font-family","font-weight","font-size","background-color","line-height"],$.extend(Overlay.prototype,{val:function(value){return null==value?this.$textarea.origVal():this.setVal(value)},setVal:function(value){return this.$textarea.origVal(value),this},onInput:function(e){},renderTextOnOverlay:function(){var text,i,l,strategy,match,style;for(text=escape(this.$textarea.val()),i=0,l=this.strategies.length;l>i;i++)strategy=this.strategies[i],match=strategy.match,$.isArray(match)&&(match=$.map(match,function(str){return str.replace(/(\(|\)|\|)/g,"$1")}),match=new RegExp("("+match.join("|")+")","g")),style="background-color:"+strategy.css["background-color"],text=text.replace(match,function(str){return'<span style="'+style+'">'+str+"</span>"});return this.$el.html(text),this},resizeOverlay:function(){this.$el.css({top:this.textareaTop-this.$textarea.scrollTop()})}}),Overlay}();$.fn.overlay=function(options){return new Overlay(this,options),this}}(window.jQuery),function($){"use strict";var lock=function(func){var free,locked;return free=function(){locked=!1},function(){var args;locked||(locked=!0,args=toArray(arguments),args.unshift(free),func.apply(this,args))}},toArray=function(args){var result;return result=Array.prototype.slice.call(args)},bind=function(func,context){return func.bind?func.bind(context):function(){func.apply(context,arguments)}},getStyles=function(){var color;return color=$("<div></div>").css(["color"]).color,"undefined"!=typeof color?function($el,properties){return $el.css(properties)}:function($el,properties){var styles;return styles={},$.each(properties,function(i,property){styles[property]=$el.css(property)}),styles}}(),identity=function(obj){return obj},memoize=function(func){var memo={};return function(term,callback){memo[term]?callback(memo[term]):func.call(this,term,function(data){memo[term]=(memo[term]||[]).concat(data),callback.apply(null,arguments)})}},include=function(array,value){var i,l;if(array.indexOf)return-1!=array.indexOf(value);for(i=0,l=array.length;l>i;i++)if(array[i]===value)return!0;return!1},Completer=function(){function Completer($el,strategies){var $wrapper,$list,focused;$list=$baseList.clone(),this.el=$el.get(0),this.$el=$el;var rawInputId=$el.data("raw-input");this.rawInput=jQuery("#"+rawInputId);var rawInputVal=this.rawInput.val();if(rawInputVal="undefined"!=typeof rawInputVal?rawInputVal.trim():"",this.tagged_list=[],rawInputVal.length>0){for(var matches,reg=/@\[([0-9]+) (.+?)\]/g,inputVal=rawInputVal;null!==(matches=reg.exec(rawInputVal));){var tagId=matches[1],tagName=matches[2];inputVal=inputVal.replace(matches[0],"@"+tagName),this.tagged_list[tagId]={id:tagId,name:tagName}}$el.val(inputVal)}$wrapper=prepareWrapper(this.$el),focused=this.el===document.activeElement,this.$el.wrap($wrapper).before($list),focused&&this.el.focus(),this.listView=new ListView($list,this),this.strategies=strategies,this.$el.on("keyup",bind(this.onKeyup,this)),this.$el.on("keydown",bind(this.listView.onKeydown,this.listView)),this.$el.on("input",bind(this.onInput,this)),this.$el.on("change",bind(this.onInput,this)),this.lastCaller=0,$(document).on("click",bind(function(e){e.originalEvent&&!e.originalEvent.keepTextCompleteDropdown&&this.listView.deactivate()},this))}var html,css,$baseWrapper,$baseList,tagged_list;html={wrapper:'<div class="textcomplete-wrapper"></div>',list:'<ul class="halo-dropdown-autocomplete"></ul>'},css={wrapper:{position:"relative"},list:{position:"absolute",top:0,left:0,zIndex:"100",display:"none"}},tagged_list=[],$baseWrapper=$(html.wrapper).css(css.wrapper),$baseList=$(html.list).css(css.list),$.extend(Completer.prototype,{renderList:function(data){this.clearAtNext&&(this.listView.clear(),this.clearAtNext=!1),data.length&&(this.listView.shown||(this.listView.setPosition(this.getCaretPosition()).clear().activate(),this.listView.strategy=this.strategy),data=data.slice(0,this.strategy.maxCount),this.listView.render(data)),!this.listView.data.length&&this.listView.shown&&this.listView.deactivate()},searchCallbackFactory:function(free){var self=this;return function(data,keep){self.renderList(data),keep||(free(),self.clearAtNext=!0)}},onKeyup:function(e){var searchQuery,term;this.addCaller();var callNum=this.getCaller();if(searchQuery=this.extractSearchQuery(this.getTextFromHeadToCaret()),searchQuery.length){if(term=searchQuery[1],this.term===term)return;this.term=term;var completer=this;setTimeout(function(){var lastCaller=completer.getCaller();callNum>=lastCaller&&(completer.resetCaller(),completer.search(searchQuery))},500)}else this.term=null,this.listView.deactivate()},onSelect:function(value){var pre,post,newSubStr;pre=this.getTextFromHeadToCaret(),post=this.el.value.substring(this.el.selectionEnd),newSubStr=this.strategy.replace(value),$.isArray(newSubStr)&&(post=newSubStr[1]+post,newSubStr=newSubStr[0]),pre=pre.replace(this.strategy.match,newSubStr);var tagged_list=this.getTaggedList();tagged_list[value.id]=value,this.setTaggedList(tagged_list),this.updateRawContent(pre+post),this.$el.val(pre+post),this.el.focus(),this.el.selectionStart=this.el.selectionEnd=pre.length},onInput:function(e){var text=this.$el.val();this.updateRawContent(text)},getTaggedList:function(){return"undefined"==typeof this.tagged_list&&(this.tagged_list=[]),this.tagged_list},setTaggedList:function(list){this.taggedList=list},addCaller:function(){var curr=this.lastCaller+1;return this.lastCaller=curr,this.lastCaller},getCaller:function(){return this.lastCaller},resetCaller:function(){this.lastCaller=0},updateRawContent:function(content){tagged_list=this.getTaggedList();var rawContent,overlayContent;rawContent=content,overlayContent=content;for(var key in tagged_list){var ele=tagged_list[key],searchStr="@"+ele.name,replaceStr="@["+ele.id+" "+ele.name+"]",replaceOverlay="<b>@"+ele.name+"</b>";if(rawContent.search(searchStr)<0)tagged_list.splice(key,1),this.setTaggedList(tagged_list);else{{new RegExp(searchStr,"g")}rawContent=rawContent.replace(searchStr,replaceStr),overlayContent=overlayContent.replace(searchStr,replaceOverlay)}}this.rawInput.val(rawContent);var overlay=this.$el.prev(".textoverlay");overlay.html(overlayContent)},getCaretPosition:function(){if(0!==this.el.selectionEnd){var properties,css,$div,$span,position,dir;return dir=this.$el.attr("dir")||this.$el.css("direction"),properties=["border-width","font-family","font-size","font-style","font-variant","font-weight","height","letter-spacing","word-spacing","line-height","text-decoration","text-align","width","padding-top","padding-right","padding-bottom","padding-left","margin-top","margin-right","margin-bottom","margin-left"],css=$.extend({position:"absolute",overflow:"auto","white-space":"pre-wrap",top:0,left:-9999,direction:dir},getStyles(this.$el,properties)),$div=$("<div></div>").css(css).text(this.getTextFromHeadToCaret()),$span=$("<span></span>").text(".").appendTo($div),this.$el.before($div),position=$span.position(),position.top+=$span.height()-this.$el.scrollTop(),"rtl"==dir&&(position.left-=this.listView.$el.width()),$div.remove(),position}},getTextFromHeadToCaret:function(){var text,selectionEnd,range;return selectionEnd=this.el.selectionEnd,"number"==typeof selectionEnd?text=this.el.value.substring(0,selectionEnd):document.selection&&(range=this.el.createTextRange(),range.moveStart("character",0),range.moveEnd("textedit"),text=range.text),text},extractSearchQuery:function(text){var i,l,strategy,match;for(i=0,l=this.strategies.length;l>i;i++)if(strategy=this.strategies[i],match=text.match(strategy.match))return[strategy,match[strategy.index]];return[]},search:lock(function(free,searchQuery){var term;this.strategy=searchQuery[0],term=searchQuery[1],this.strategy.search(term,this.searchCallbackFactory(free))})});var prepareWrapper=function($el){return $baseWrapper.clone().css("display",$el.css("display"))};return Completer}(),ListView=function(){function ListView($el,completer){this.data=[],this.$el=$el,this.index=0,this.completer=completer,this.$el.on("click","li.textcomplete-item",bind(this.onClick,this))}return $.extend(ListView.prototype,{shown:!1,render:function(data){var html,i,l,index,val;for(html="",i=0,l=data.length;l>i&&(val=data[i],include(this.data,val)||(index=this.data.length,this.data.push(val),html+='<li class="textcomplete-item" data-index="'+index+'"><a>',html+=this.strategy.template(val),html+="</a></li>",this.data.length!==this.strategy.maxCount));i++);this.$el.append(html),this.data.length?this.activateIndexedItem():this.deactivate()},clear:function(){return this.data=[],this.$el.html(""),this.index=0,this},activateIndexedItem:function(){this.$el.find(".active").removeClass("active"),this.getActiveItem().addClass("active")},getActiveItem:function(){return $(this.$el.children().get(this.index))},activate:function(){return this.shown||(this.$el.show(),this.shown=!0),this},deactivate:function(){return this.shown&&(this.$el.hide(),this.shown=!1,this.data=this.index=null),this},setPosition:function(position){return this.$el.css(position),this},select:function(index){this.completer.onSelect(this.data[index]),this.deactivate()},onKeydown:function(e){this.shown&&(27===e.keyCode?this.deactivate():38===e.keyCode?(e.preventDefault(),0===this.index?this.index=this.data.length-1:this.index-=1,this.activateIndexedItem()):40===e.keyCode?(e.preventDefault(),this.index===this.data.length-1?this.index=0:this.index+=1,this.activateIndexedItem()):(13===e.keyCode||9===e.keyCode)&&(e.stopImmediatePropagation(),e.preventDefault(),this.select(parseInt(this.getActiveItem().data("index")))))},onClick:function(e){var $e=$(e.target);e.originalEvent.keepTextCompleteDropdown=!0,$e.hasClass("textcomplete-item")||($e=$e.parents("li.textcomplete-item")),this.select(parseInt($e.data("index")))}}),ListView}();$.fn.textcomplete=function(strategies){var i,l,strategy;for(i=0,l=strategies.length;l>i;i++)strategy=strategies[i],strategy.template||(strategy.template=identity),null==strategy.index&&(strategy.index=2),strategy.cache&&(strategy.search=memoize(strategy.search)),strategy.maxCount||(strategy.maxCount=10);return new Completer(this,strategies),this}}(window.jQuery);