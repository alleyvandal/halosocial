!function($){"use strict";var Markdown=function(element,options){this.$ns="halo-md",this.$element=$(element),this.$editable={el:null,type:null,attrKeys:[],attrValues:[],content:null},this.$options=$.extend(!0,{},$.fn.markdown.defaults,options),this.$oldContent=null,this.$isPreview=!1,this.$editor=null,this.$textarea=null,this.$handler=[],this.$callback=[],this.$nextTab=[],this.showEditor()};Markdown.prototype={constructor:Markdown,__alterButtons:function(name,alter){var handler=this.$handler,isAll="all"==name,that=this;$.each(handler,function(k,v){var halt=!0;halt=isAll?!1:v.indexOf(name)<0,0==halt&&alter(that.$editor.find('button[data-handler="'+v+'"]'))})},__buildButtons:function(buttonsArray,container){var i,ns=this.$ns,handler=this.$handler,callback=this.$callback;for(i=0;i<buttonsArray.length;i++){var y,btnGroups=buttonsArray[i];for(y=0;y<btnGroups.length;y++){var z,buttons=btnGroups[y].data,btnGroupContainer=$("<div/>",{"class":"halo-btn-group"});for(z=0;z<buttons.length;z++){var button=buttons[z],buttonToggle="",buttonHandler=ns+"-"+button.name,buttonIcon=button.icon instanceof Object?button.icon[this.$options.iconlibrary]:button.icon,btnText=button.btnText?button.btnText:"",btnClass=button.btnClass?button.btnClass:"halo-btn",tabIndex=button.tabIndex?button.tabIndex:"-1";1==button.toggle&&(buttonToggle=' data-toggle="button"'),btnGroupContainer.append('<button type="button" class="'+btnClass+' halo-btn-default halo-btn-sm" title="'+this.__localize(button.title)+'" tabindex="'+tabIndex+'" data-provider="'+ns+'" data-handler="'+buttonHandler+'"'+buttonToggle+'><span class="'+buttonIcon+'"></span> '+this.__localize(btnText)+"</button>"),handler.push(buttonHandler),callback.push(button.callback)}container.append(btnGroupContainer)}}return container},__setListener:function(){var hasRows="undefined"!=typeof this.$textarea.attr("rows"),maxRows=this.$textarea.val().split("\n").length>5?this.$textarea.val().split("\n").length:"5",rowsVal=hasRows?this.$textarea.attr("rows"):maxRows;this.$textarea.attr("rows",rowsVal),this.$options.resize&&this.$textarea.css("resize",this.$options.resize),this.$textarea.on("focus",$.proxy(this.focus,this)).on("keypress",$.proxy(this.keypress,this)).on("keyup",$.proxy(this.keyup,this)),this.eventSupported("keydown")&&this.$textarea.on("keydown",$.proxy(this.keydown,this)),this.$textarea.data("markdown",this)},__handle:function(e){var target=$(e.currentTarget),handler=this.$handler,callback=this.$callback,handlerName=target.attr("data-handler"),callbackIndex=handler.indexOf(handlerName),callbackHandler=callback[callbackIndex];$(e.currentTarget).focus(),callbackHandler(this),handlerName.indexOf("cmdSave")<0&&this.$textarea.focus(),e.preventDefault()},__localize:function(string){var messages=$.fn.markdown.messages,language=this.$options.language;return"undefined"!=typeof messages&&"undefined"!=typeof messages[language]&&"undefined"!=typeof messages[language][string]?messages[language][string]:string},showEditor:function(){var textarea,instance=this,ns=this.$ns,container=this.$element,editable=(container.css("height"),container.css("width"),this.$editable),handler=this.$handler,callback=this.$callback,options=this.$options,editor=$("<div/>",{"class":"md-editor",click:function(){instance.focus()}});if(null==this.$editor){var editorHeader=$("<div/>",{"class":"md-header halo-btn-toolbar"+("undefined"==typeof this.$options.headerclass?"":" "+this.$options.headerclass)}),allBtnGroups=[];if(options.buttons.length>0&&(allBtnGroups=allBtnGroups.concat(options.buttons[0])),options.additionalButtons.length>0&&(allBtnGroups=allBtnGroups.concat(options.additionalButtons[0])),options.reorderButtonGroups.length>0&&(allBtnGroups=allBtnGroups.filter(function(btnGroup){return options.reorderButtonGroups.indexOf(btnGroup.name)>-1}).sort(function(a,b){return options.reorderButtonGroups.indexOf(a.name)<options.reorderButtonGroups.indexOf(b.name)?-1:options.reorderButtonGroups.indexOf(a.name)>options.reorderButtonGroups.indexOf(b.name)?1:0})),allBtnGroups.length>0&&(editorHeader=this.__buildButtons([allBtnGroups],editorHeader)),editor.append(editorHeader),container.is("textarea"))container.before(editor),textarea=container,textarea.addClass("md-input"),editor.append(textarea);else{var rawContent="function"==typeof toMarkdown?toMarkdown(container.html()):container.html(),currentContent=$.trim(rawContent);textarea=$("<textarea/>",{"class":"md-input",val:currentContent}),editor.append(textarea),editable.el=container,editable.type=container.prop("tagName").toLowerCase(),editable.content=container.html(),$(container[0].attributes).each(function(){editable.attrKeys.push(this.nodeName),editable.attrValues.push(this.nodeValue)}),container.replaceWith(editor)}if(options.savable){var editorFooter=$("<div/>",{"class":"md-footer"}),saveHandler="cmdSave";handler.push(saveHandler),callback.push(options.onSave),editorFooter.append('<button class="halo-btn halo-btn-success" data-provider="'+ns+'" data-handler="'+saveHandler+'"><i class="icon icon-white icon-ok"></i> '+this.__localize("Save")+"</button>"),editor.append(editorFooter)}if(options.width&&"inherit"!==options.width&&(jQuery.isNumeric(options.width)?(editor.css("display","table"),textarea.css("width",options.width+"px")):editor.addClass(options.width)),options.height&&"inherit"!==options.height)if(jQuery.isNumeric(options.height)){var height=options.height;editorHeader&&(height=Math.max(0,height-editorHeader.outerHeight())),editorFooter&&(height=Math.max(0,height-editorFooter.outerHeight())),textarea.css("height",height+"px")}else editor.addClass(options.height);this.$editor=editor,this.$textarea=textarea,this.$editable=editable,this.$oldContent=this.getContent(),this.__setListener(),this.$editor.attr("id",(new Date).getTime()),this.$editor.on("click",'[data-provider="'+this.$ns+'"]',$.proxy(this.__handle,this))}else this.$editor.show();return options.autofocus&&(this.$textarea.focus(),this.$editor.addClass("active")),options.onShow(this),this},showPreview:function(){var content,options=this.$options,callbackContent=options.onPreview(this),container=this.$textarea,afterContainer=container.next(),replacementContainer=$("<div/>",{"class":"md-preview","data-provider":"markdown-preview"});if(this.$isPreview=!0,this.disableButtons("all").enableButtons("cmdPreview"),"string"==typeof callbackContent)content=callbackContent;else{var val=container.val();content="object"==typeof markdown?markdown.toHTML(val):"function"==typeof marked?marked(val):val}return replacementContainer.html(content),afterContainer&&"md-footer"==afterContainer.attr("class")?replacementContainer.insertBefore(afterContainer):container.parent().append(replacementContainer),replacementContainer.css({width:container.outerWidth()+"px",height:container.outerHeight()+"px"}),container.hide(),replacementContainer.data("markdown",this),this},hidePreview:function(){this.$isPreview=!1;var container=this.$editor.find('div[data-provider="markdown-preview"]');return container.remove(),this.enableButtons("all"),this.$textarea.show(),this.__setListener(),this},isDirty:function(){return this.$oldContent!=this.getContent()},getContent:function(){return this.$textarea.val()},setContent:function(content){return this.$textarea.val(content),this},findSelection:function(chunk){var startChunkPosition,content=this.getContent();if(startChunkPosition=content.indexOf(chunk),startChunkPosition>=0&&chunk.length>0){var selection,oldSelection=this.getSelection();return this.setSelection(startChunkPosition,startChunkPosition+chunk.length),selection=this.getSelection(),this.setSelection(oldSelection.start,oldSelection.end),selection}return null},getSelection:function(){var e=this.$textarea[0];return("selectionStart"in e&&function(){var l=e.selectionEnd-e.selectionStart;return{start:e.selectionStart,end:e.selectionEnd,length:l,text:e.value.substr(e.selectionStart,l)}}||function(){return null})()},setSelection:function(start,end){var e=this.$textarea[0];return("selectionStart"in e&&function(){e.selectionStart=start,e.selectionEnd=end}||function(){return null})()},replaceSelection:function(text){var e=this.$textarea[0];return("selectionStart"in e&&function(){return e.value=e.value.substr(0,e.selectionStart)+text+e.value.substr(e.selectionEnd,e.value.length),e.selectionStart=e.value.length,jQuery(e).trigger("change"),this}||function(){return e.value+=text,jQuery(e).trigger("change"),jQuery(e)})()},getNextTab:function(){if(0==this.$nextTab.length)return null;var nextTab,tab=this.$nextTab.shift();return"function"==typeof tab?nextTab=tab():"object"==typeof tab&&tab.length>0&&(nextTab=tab),nextTab},setNextTab:function(start,end){if("string"==typeof start){var that=this;this.$nextTab.push(function(){return that.findSelection(start)})}else if("numeric"==typeof start&&"numeric"==typeof end){var oldSelection=this.getSelection();this.setSelection(start,end),this.$nextTab.push(this.getSelection()),this.setSelection(oldSelection.start,oldSelection.end)}},enableButtons:function(name){var alter=function(el){el.removeAttr("disabled")};return this.__alterButtons(name,alter),this},disableButtons:function(name){var alter=function(el){el.attr("disabled","disabled")};return this.__alterButtons(name,alter),this},eventSupported:function(eventName){var isSupported=eventName in this.$element;return isSupported||(this.$element.setAttribute(eventName,"return;"),isSupported="function"==typeof this.$element[eventName]),isSupported},keydown:function(e){this.suppressKeyPressRepeat=~$.inArray(e.keyCode,[40,38,9,13,27]),this.keyup(e)},keypress:function(e){this.suppressKeyPressRepeat||this.keyup(e)},keyup:function(e){var blocked=!1;switch(e.keyCode){case 40:case 38:case 16:case 17:case 18:break;case 9:var nextTab;if(nextTab=this.getNextTab(),null!=nextTab){var that=this;setTimeout(function(){that.setSelection(nextTab.start,nextTab.end)},500),blocked=!0}else{var cursor=this.getSelection();cursor.start==cursor.end&&cursor.end==this.getContent().length?blocked=!1:(this.setSelection(this.getContent().length,this.getContent().length),blocked=!0)}break;case 13:case 27:blocked=!1;break;default:blocked=!1}blocked&&(e.stopPropagation(),e.preventDefault())},focus:function(e){var options=this.$options,editor=(options.hideable,this.$editor);return editor.addClass("active"),$(document).find(".md-editor").each(function(){if($(this).attr("id")!=editor.attr("id")){var attachedMarkdown;attachedMarkdown=$(this).find("textarea").data("markdown"),null==attachedMarkdown&&(attachedMarkdown=$(this).find('div[data-provider="markdown-preview"]').data("markdown")),attachedMarkdown&&attachedMarkdown.blur()}}),options.onFocus(this),this},blur:function(e){var options=this.$options,isHideable=options.hideable,editor=this.$editor,editable=this.$editable;if(editor.hasClass("active")||0==this.$element.parent().length){if(editor.removeClass("active"),isHideable)if(null!=editable.el){var oldElement=$("<"+editable.type+"/>"),content=this.getContent(),currentContent="object"==typeof markdown?markdown.toHTML(content):content;$(editable.attrKeys).each(function(k,v){oldElement.attr(editable.attrKeys[k],editable.attrValues[k])}),oldElement.html(currentContent),editor.replaceWith(oldElement)}else editor.hide();options.onBlur(this)}return this}};var old=$.fn.markdown;$.fn.markdown=function(option){return this.each(function(){var $this=$(this),data=$this.data("markdown"),options="object"==typeof option&&option;data||$this.data("markdown",data=new Markdown(this,options))})},$.fn.markdown.messages={},$.fn.markdown.defaults={autofocus:!1,hideable:!1,savable:!1,width:"inherit",height:"inherit",resize:"none",iconlibrary:"fa",language:"en",buttons:[[{name:"groupFont",data:[{name:"cmdBold",title:"Bold",icon:{glyph:"glyphicon glyphicon-bold",fa:"fa fa-bold","fa-3":"icon-bold"},callback:function(e){var chunk,cursor,selected=e.getSelection(),content=e.getContent();chunk=0==selected.length?e.__localize("strong text"):selected.text,"**"==content.substr(selected.start-2,2)&&"**"==content.substr(selected.end,2)?(e.setSelection(selected.start-2,selected.end+2),e.replaceSelection(chunk),cursor=selected.start-2):(e.replaceSelection("**"+chunk+"**"),cursor=selected.start+2),e.setSelection(cursor,cursor+chunk.length)}},{name:"cmdItalic",title:"Italic",icon:{glyph:"glyphicon glyphicon-italic",fa:"fa fa-italic","fa-3":"icon-italic"},callback:function(e){var chunk,cursor,selected=e.getSelection(),content=e.getContent();chunk=0==selected.length?e.__localize("emphasized text"):selected.text,"*"==content.substr(selected.start-1,1)&&"*"==content.substr(selected.end,1)?(e.setSelection(selected.start-1,selected.end+1),e.replaceSelection(chunk),cursor=selected.start-1):(e.replaceSelection("*"+chunk+"*"),cursor=selected.start+1),e.setSelection(cursor,cursor+chunk.length)}},{name:"cmdHeading",title:"Heading",icon:{glyph:"glyphicon glyphicon-header",fa:"fa fa-font","fa-3":"icon-font"},callback:function(e){var chunk,cursor,pointer,prevChar,selected=e.getSelection(),content=e.getContent();chunk=0==selected.length?e.__localize("heading text"):selected.text+"\n",pointer=4,"### "==content.substr(selected.start-pointer,pointer)||(pointer=3,"###"==content.substr(selected.start-pointer,pointer))?(e.setSelection(selected.start-pointer,selected.end),e.replaceSelection(chunk),cursor=selected.start-pointer):selected.start>0&&(prevChar=content.substr(selected.start-1,1),!!prevChar&&"\n"!=prevChar)?(e.replaceSelection("\n\n### "+chunk),cursor=selected.start+6):(e.replaceSelection("### "+chunk),cursor=selected.start+4),e.setSelection(cursor,cursor+chunk.length)}}]},{name:"groupLink",data:[{name:"cmdUrl",title:"URL/Link",icon:{glyph:"glyphicon glyphicon-globe",fa:"fa fa-globe","fa-3":"icon-globe"},callback:function(e){{var chunk,cursor,link,selected=e.getSelection();e.getContent()}chunk=0==selected.length?e.__localize("enter link description here"):selected.text,link=prompt(e.__localize("Insert Hyperlink"),"http://"),null!=link&&""!=link&&"http://"!=link&&(e.replaceSelection("["+chunk+"]("+link+")"),cursor=selected.start+1,e.setSelection(cursor,cursor+chunk.length))}},{name:"cmdImage",title:"Image",icon:{glyph:"glyphicon glyphicon-picture",fa:"fa fa-picture-o","fa-3":"icon-picture"},callback:function(e){{var chunk,cursor,link,selected=e.getSelection();e.getContent()}chunk=0==selected.length?e.__localize("enter image description here"):selected.text,link=prompt(e.__localize("Insert Image Hyperlink"),"http://"),null!=link&&(e.replaceSelection("!["+chunk+"]("+link+' "'+e.__localize("enter image title here")+'")'),cursor=selected.start+2,e.setNextTab(e.__localize("enter image title here")),e.setSelection(cursor,cursor+chunk.length))}}]},{name:"groupMisc",data:[{name:"cmdList",title:"List",icon:{glyph:"glyphicon glyphicon-list",fa:"fa fa-list","fa-3":"icon-list-ul"},callback:function(e){{var chunk,cursor,selected=e.getSelection();e.getContent()}if(0==selected.length)chunk=e.__localize("list text here"),e.replaceSelection("- "+chunk),cursor=selected.start+2;else if(selected.text.indexOf("\n")<0)chunk=selected.text,e.replaceSelection("- "+chunk),cursor=selected.start+2;else{var list=[];list=selected.text.split("\n"),chunk=list[0],$.each(list,function(k,v){list[k]="- "+v}),e.replaceSelection("\n\n"+list.join("\n")),cursor=selected.start+4}e.setSelection(cursor,cursor+chunk.length)}}]},{name:"groupCustom",data:[{name:"cmdEmoticons",toggle:!1,title:"Emoticons",icon:{glyph:"glyphicon glyphicon-search",fa:"fa fa-smile-o","fa-3":"icon-smile-o"},callback:function(e){var $editorWrapper=e.$element.closest(".md-editor"),buttonHandler=e.$ns+"-cmdEmoticons",$ePopover=jQuery('[data-handler="'+buttonHandler+'"]',$editorWrapper).hpopover({template:'<div class="popover emoticons-popover"><div class="arrow"></div><div class="popover-content"></div></div>',content:function(){var html="";return html},html:!0,trigger:"manual"}).on("shown.bs.hpopover",function(){{var $this=jQuery(this),$emojiContainer=$this.next(),$wrapper=jQuery(".popover-content",$emojiContainer);e.getSelection()}if(!$wrapper.children().length)for(var i=0;i<halo.emoji.popular.length;i++)$wrapper.append(jQuery('<a href="javascript:void(0)" >'+emojify.replace(":"+halo.emoji.popular[i]+":")+"</a>").on("click",function(ele){var $this=jQuery(this),emojiName=jQuery("img",$this).attr("title");e.replaceSelection(emojiName),$ePopover.hpopover("toggle")}))}).hpopover("toggle")}}]}]],additionalButtons:[],reorderButtonGroups:[],onShow:function(e){},onPreview:function(e){},onSave:function(e){},onBlur:function(e){},onFocus:function(e){}},$.fn.markdown.Constructor=Markdown,$.fn.markdown.noConflict=function(){return $.fn.markdown=old,this};var initMarkdown=function(el){var $this=el;return $this.data("markdown")?void $this.data("markdown").showEditor():void $this.markdown($this.data())},analyzeMarkdown=function(e){var el,blurred=!1,$docEditor=$(e.currentTarget);"focusin"!=e.type&&"click"!=e.type||1!=$docEditor.length||"object"!=typeof $docEditor[0]||(el=$docEditor[0].activeElement,$(el).data("markdown")||("undefined"==typeof $(el).parent().parent().parent().attr("class")||$(el).parent().parent().parent().attr("class").indexOf("md-editor")<0?("undefined"==typeof $(el).parent().parent().attr("class")||$(el).parent().parent().attr("class").indexOf("md-editor")<0)&&(blurred=!0):blurred=!1),blurred&&$(document).find(".md-editor").each(function(){var parentMd=$(el).parent();if($(this).attr("id")!=parentMd.attr("id")){var attachedMarkdown;attachedMarkdown=$(this).find("textarea").data("markdown"),null==attachedMarkdown&&(attachedMarkdown=$(this).find('div[data-provider="markdown-preview"]').data("markdown")),attachedMarkdown&&attachedMarkdown.blur()}}),e.stopPropagation())};$(document).on("click.markdown.data-api",'[data-provide="markdown-editable"]',function(e){initMarkdown($(this)),e.preventDefault()}).on("click",function(e){analyzeMarkdown(e)}).on("focusin",function(e){analyzeMarkdown(e)}).ready(function(){$('textarea[data-provide="markdown"]').each(function(){initMarkdown($(this))})})}(window.jQuery);